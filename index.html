<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Learn - AI Language Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import and styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Custom scrollbar for chat/content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Slate 300 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2 text-2xl font-extrabold text-indigo-600 tracking-tight" onclick="navigate('home')">
                <i data-lucide="graduation-cap" class="w-6 h-6 text-indigo-500"></i>
                <span>Easy Learn</span>
            </a>
            <nav class="hidden md:flex space-x-6 text-gray-700 font-medium">
                <a href="#" class="hover:text-indigo-600 transition duration-150" onclick="navigate('home')">Home</a>
                <a href="#" class="hover:text-indigo-600 transition duration-150" id="dashboard-nav-link">Dashboard</a>
                <a href="#" class="hover:text-indigo-600 transition duration-150" onclick="navigate('about')">About</a>
                <button class="text-white bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-full shadow-md transition duration-150" id="auth-button">Login</button>
            </nav>
            <button id="mobile-menu-button" class="md:hidden p-2 text-gray-700 hover:text-indigo-600" onclick="toggleMobileMenu()">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-inner pb-2 border-t">
            <nav class="flex flex-col space-y-2 px-4 py-2 font-medium">
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" onclick="navigate('home')">Home</a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" id="dashboard-nav-link-mobile">Dashboard</a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" onclick="navigate('about')">About</a>
                <button class="block px-3 py-2 rounded-md text-white bg-indigo-500 text-center rounded-full mt-2" id="auth-button-mobile">Login</button>
            </nav>
        </div>
    </header>

    <main id="app-content" class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 w-full"></main>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500 border-opacity-20 border-t-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold" id="loading-message">Loading Easy Learn...</p>
        </div>
    </div>
    
    <div id="ai-loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="animate-pulse rounded-full h-10 w-10 bg-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold text-lg">AI Tutor is thinking...</p>
            <p class="text-sm text-gray-500 mt-1">Fetching information from the web.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signOut, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            deleteField 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- GLOBAL ENVIRONMENT VARIABLES (MANDATORY USE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-easy-learn-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END OF GLOBAL ENVIRONMENT VARIABLES ---

        // --- ADMIN CONFIGURATION ---
        // Define the email address that will be granted admin privileges
        const ADMIN_EMAIL = "admin@easy-learn.com"; 
        const ADMIN_PASSWORD = 123456;

        // Global variables for Firebase services and state
        let app = null;
        let db;
        let auth;
        let userId = null;
        let userEmail = null;
        let isAdmin = false;
        let isAuthReady = false; // <<< FIX: Defined isAuthReady globally

        // Global application state
        window.appState = {
            currentPage: 'home',
            selectedLanguage: null,
            chatHistory: [],
            isChatLoading: false,
            // Languages are now managed dynamically via Firestore
            languagesConfig: null, 
            isConfigLoaded: false
        };

        // Default language map for initialization if Firestore is empty or not available
        const DEFAULT_LANGUAGE_MAP = {
            english: { name: "English", icon: "book-open", color: "bg-green-500", accent: "text-green-600" },
            hindi: { name: "Hindi (हिंदी)", icon: "landmark", color: "bg-red-500", accent: "text-red-600" },
            telugu: { name: "Telugu (తెలుగు)", icon: "users", color: "bg-blue-500", accent: "text-blue-600" },
            tamil: { name: "Tamil (தமிழ்)", icon: "bus", color: "bg-yellow-500", accent: "text-yellow-600" }
        };

        // Firestore paths for public configuration (must be correct for security rules)
        const SITE_CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/site_settings/languages_config`;

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        function handleAppReady() {
            const loadingOverlay = document.getElementById('loading-overlay');
             if (isAuthReady && window.appState.isConfigLoaded) {
                renderApp();
                loadingOverlay.classList.add('hidden');
            }
        }

        async function initializeFirebase() {
            try {
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingMessage = document.getElementById('loading-message');
                loadingOverlay.classList.remove('hidden');

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // 1. Setup Firestore Listener for Language Config
                    setupConfigListener();

                    // 2. Setup Auth State Listener
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userEmail = user.email || null;
                            isAdmin = userEmail === ADMIN_EMAIL;
                            console.log("Auth state changed. User ID:", userId, "Admin:", isAdmin);
                        } else {
                            userId = null;
                            userEmail = null;
                            isAdmin = false;
                            console.log("User signed out.");
                            
                            // Attempt to sign in if no user is present (handles initial auth token)
                            if (initialAuthToken) {
                                loadingMessage.textContent = "Authenticating secure session...";
                                await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                    console.warn("Custom token sign-in failed. Attempting anonymous.", e);
                                    return signInAnonymously(auth);
                                });
                            } else if (!auth.currentUser) {
                                await signInAnonymously(auth);
                            }
                        }
                        
                        isAuthReady = true; 
                        updateUIOnAuth();
                        handleAppReady();
                    });
                } else {
                    // Running locally without config - use default config and mock auth
                    console.warn("Firebase config is missing. Running in local development mode.");
                    auth = { currentUser: null }; 
                    window.appState.languagesConfig = DEFAULT_LANGUAGE_MAP;
                    window.appState.isConfigLoaded = true;
                    isAuthReady = true;
                    updateUIOnAuth();
                    handleAppReady();
                }
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function setupConfigListener() {
            const configRef = doc(db, SITE_CONFIG_DOC_PATH);
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().languages) {
                    window.appState.languagesConfig = docSnap.data().languages;
                    console.log("Site config loaded from Firestore.");
                } else {
                    // Initialize with defaults if the document doesn't exist.
                    // This will only save if an admin is logged in (handled inside saveLanguagesConfig)
                    window.appState.languagesConfig = DEFAULT_LANGUAGE_MAP;
                    console.log("Site config initialized with default values.");
                    if (isAdmin) saveLanguagesConfig(window.appState.languagesConfig);
                }
                window.appState.isConfigLoaded = true;
                handleAppReady();
            }, (error) => {
                // This is the error handler for the onSnapshot listener itself
                console.error("Error listening to site config (Potential Permissions Issue):", error);
                // Fallback to defaults if access fails
                window.appState.languagesConfig = DEFAULT_LANGUAGE_MAP;
                window.appState.isConfigLoaded = true;
                handleAppReady();
            });
        }

        /**
         * Generic Modal for displaying messages (replaces native alert)
         * @param {string} title - The title of the modal.
         * @param {string} message - The message body.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showCustomModal(title, message, type = 'info') {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            let borderColor = 'border-indigo-500';
            let titleColor = 'text-indigo-600';
            
            if (type === 'error') {
                borderColor = 'border-red-500';
                titleColor = 'text-red-600';
            } else if (type === 'success') {
                borderColor = 'border-green-500';
                titleColor = 'text-green-600';
            }

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center border-t-4 ${borderColor}">
                        <h3 class="text-xl font-bold ${titleColor} mb-3">${title}</h3>
                        <p class="text-gray-700 mb-4">${message}</p>
                        <button class="bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-700 transition duration-150" onclick="document.getElementById('custom-alert-modal').remove()">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Handles Log In and Sign Up for both users and the admin.
         */
        async function handleEmailPasswordAuth(mode, email, password) {
            if (!app) {
                return showCustomModal("Local Mode", "Cannot perform live authentication in this environment. Running simulation.", 'info');
            }

            try {
                let userCredential;
                if (mode === 'signup') {
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    showCustomModal("Success!", "Account created successfully. Welcome!", 'success');
                } else { // mode === 'login'
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                    showCustomModal("Welcome Back!", "Logged in successfully.", 'success');
                }
                
                // After successful login/signup, check role and navigate
                const isCurrentUserAdmin = userCredential.user.email === ADMIN_EMAIL;
                navigate(isCurrentUserAdmin ? 'admin-dashboard' : 'dashboard');

            } catch (error) {
                console.error(`${mode} failed:`, error);
                let errorMessage = "An unknown error occurred. Please try again.";
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered. Please log in.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address is not valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "The password is too weak. Please use at least 6 characters.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                }

                showCustomModal(`${mode === 'signup' ? 'Sign Up' : 'Log In'} Failed`, errorMessage, 'error');
            }
        }
        
        window.handleFormSubmit = function(event, mode) {
            event.preventDefault();
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value.trim();
            
            if (!email || !password) {
                return showCustomModal("Input Error", "Please enter both email and password.", 'error');
            }

            handleEmailPasswordAuth(mode, email, password);
        }

        async function handleLogout() {
            if (!auth || !app) {
                // Handle logout simulation for local dev
                userId = null;
                isAdmin = false;
                window.appState.selectedLanguage = null;
                window.appState.chatHistory = [];
                updateUIOnAuth();
                navigate('login');
                console.log("Simulated local logout.");
                return;
            }
            try {
                await signOut(auth);
                window.appState.selectedLanguage = null; 
                window.appState.chatHistory = []; 
                navigate('login');
                showCustomModal("Logged Out", "You have been successfully signed out.", 'info');
            } catch (error) {
                console.error("Logout failed:", error);
            }
        }

        function updateUIOnAuth() {
            const authButton = document.getElementById('auth-button');
            const authButtonMobile = document.getElementById('auth-button-mobile');
            const dashboardNavLink = document.getElementById('dashboard-nav-link');
            const dashboardNavLinkMobile = document.getElementById('dashboard-nav-link-mobile');

            if (!authButton || !dashboardNavLink) return;

            // Determine correct dashboard link based on role
            const dashboardPage = isAdmin ? 'admin-dashboard' : 'dashboard';
            const dashboardAction = () => navigate(userId ? dashboardPage : 'login');
            
            dashboardNavLink.textContent = isAdmin ? 'Admin' : 'Dashboard';
            dashboardNavLink.onclick = dashboardAction;
            dashboardNavLinkMobile.textContent = isAdmin ? 'Admin' : 'Dashboard';
            dashboardNavLinkMobile.onclick = () => { dashboardAction(); toggleMobileMenu(); };

            if (userId) {
                authButton.textContent = 'Logout';
                authButton.onclick = handleLogout;
                authButtonMobile.textContent = 'Logout';
                authButtonMobile.onclick = () => { handleLogout(); toggleMobileMenu(); };
                
            } else {
                authButton.textContent = 'Login';
                authButton.onclick = () => navigate('login');
                authButtonMobile.textContent = 'Login';
                authButtonMobile.onclick = () => { navigate('login'); toggleMobileMenu(); };

                // Redirect to login if user tries to access a restricted page while logged out
                if (window.appState.currentPage === 'dashboard' || window.appState.currentPage === 'learn' || window.appState.currentPage === 'admin-dashboard') {
                    window.appState.currentPage = 'login';
                }
            }
        }

        // --- FIREBASE ADMIN DATA MANAGEMENT ---

        async function saveLanguagesConfig(config) {
            if (!db || !isAdmin) {
                return console.error("Not authorized or database not initialized to save config.");
            }
            try {
                const configRef = doc(db, SITE_CONFIG_DOC_PATH);
                await setDoc(configRef, { languages: config });
                showCustomModal("Site Updated", "Language configuration saved successfully.", 'success');
            } catch (error) {
                console.error("Error saving config:", error);
                showCustomModal("Error Saving", "Failed to save configuration to Firestore.", 'error');
            }
        }

        window.addOrUpdateLanguage = function(event) {
            event.preventDefault();
            if (!isAdmin) return showCustomModal("Access Denied", "You must be logged in as an admin to perform this action.", 'error');

            const form = event.target;
            const key = form.elements['key'].value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const name = form.elements['name'].value.trim();
            const icon = form.elements['icon'].value.trim();
            const color = form.elements['color'].value.trim();
            
            if (!key || !name || !icon || !color) {
                return showCustomModal("Input Missing", "All fields are required.", 'error');
            }

            const newConfig = {
                ...window.appState.languagesConfig,
                [key]: { name, icon, color, accent: `text-${color.split('-')[1]}-600` }
            };
            
            // Clear form and save
            form.reset();
            saveLanguagesConfig(newConfig);
        }

        window.deleteLanguage = function(key) {
            if (!isAdmin) return showCustomModal("Access Denied", "You must be logged in as an admin to perform this action.", 'error');
            
            if (!confirm(`Are you sure you want to delete the language '${window.appState.languagesConfig[key].name}'?`)) {
                return;
            }

            const newConfig = { ...window.appState.languagesConfig };
            delete newConfig[key];
            saveLanguagesConfig(newConfig);

            // If the user was viewing this language, navigate them away
            if (window.appState.selectedLanguage === key) {
                window.appState.selectedLanguage = null;
                navigate('dashboard');
            }
        }

        // --- AI (GEMINI) API INTERACTION ---

        const AI_MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const AI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=`;

        async function askAIQuestion(question) {
            if (window.appState.isChatLoading) return;
            if (!userId) {
                showCustomModal("Authentication Required", "You must be logged in to use the AI Tutor.", 'error');
                return navigate('login');
            }
            if (!window.appState.languagesConfig || !window.appState.selectedLanguage) return;

            window.appState.isChatLoading = true;
            document.getElementById('ai-loading-modal').classList.remove('hidden');

            window.appState.chatHistory.push({ role: 'user', text: question });
            renderChat();

            const selectedLang = window.appState.languagesConfig[window.appState.selectedLanguage]?.name || 'a general language learning topic';
            const systemPrompt = `You are Easy Learn, a friendly and expert language tutor specializing in ${selectedLang}. Your role is to answer the user's questions clearly, provide simple examples, and encourage them to practice. If the user asks a question in ${selectedLang} or related to it, respond directly using ${selectedLang} and provide an English translation or explanation. Keep responses concise and directly relevant to language learning.`;

            const payload = {
                contents: [{ parts: [{ text: question }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiKey = ""; // API key will be provided by environment

            let responseText = "Sorry, I couldn't connect to the AI tutor. Please try again later.";
            let sources = [];
            let delay = 1000;
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(AI_API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        responseText = candidate.content.parts[0].text;

                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        break; // Success
                    } else {
                        throw new Error("Invalid response structure from AI.");
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }

            window.appState.chatHistory.push({ role: 'ai', text: responseText, sources: sources });
            window.appState.isChatLoading = false;
            document.getElementById('ai-loading-modal').classList.add('hidden');
            renderChat();
        }

        // --- UI/RENDERING FUNCTIONS ---

        function navigate(page, langKey = null) {
            // Admin only access check
            if (page === 'admin-dashboard' && !isAdmin) {
                showCustomModal("Access Denied", "You do not have permission to view the Admin Dashboard.", 'error');
                return navigate('dashboard');
            }

            window.appState.currentPage = page;

            if (page === 'learn' && langKey) {
                if (!userId) {
                    showCustomModal("Login Required", "Please log in first to start practicing.", 'error');
                    return navigate('login');
                }
                window.appState.selectedLanguage = langKey;
                window.appState.chatHistory = []; 
            } else if ((page === 'dashboard' || page === 'admin-dashboard') && !userId) {
                return navigate('login');
            }
            
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
            renderApp();
            lucide.createIcons();
            window.scrollTo(0, 0); 
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        function renderApp() {
            const contentDiv = document.getElementById('app-content');
            let html = '';

            if (userId && window.appState.currentPage === 'login') {
                window.appState.currentPage = isAdmin ? 'admin-dashboard' : 'dashboard';
            }
            
            // Only render if both config and auth are ready
            if (!window.appState.isConfigLoaded || !isAuthReady) {
                 return;
            }

            switch (window.appState.currentPage) {
                case 'home':
                    html = renderHomePage();
                    break;
                case 'about':
                    html = renderAboutPage();
                    break;
                case 'login':
                    html = renderLoginPage();
                    break;
                case 'admin-dashboard':
                    html = renderAdminDashboardPage();
                    break;
                case 'dashboard':
                    html = renderDashboardPage();
                    break;
                case 'learn':
                    html = renderLearnPage();
                    break;
                default:
                    html = renderHomePage();
            }

            contentDiv.innerHTML = html;
            lucide.createIcons();

            if (window.appState.currentPage === 'learn') {
                renderChat();
            }
        }

        // --- PAGE RENDERERS ---

        function renderHomePage() {
            const languages = Object.values(window.appState.languagesConfig || {});
            return `
                <div class="text-center py-20 bg-indigo-50 rounded-xl shadow-lg">
                    <i data-lucide="zap" class="w-12 h-12 mx-auto text-indigo-500 mb-4"></i>
                    <h1 class="text-5xl font-extrabold text-gray-900 leading-tight mb-4">
                        Master Languages with <span class="text-indigo-600">Easy Learn</span>
                    </h1>
                    <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
                        Ask our AI Tutor anything about any of the available languages. Get instant, real-time feedback and practice.
                    </p>
                    <button class="bg-indigo-600 text-white text-lg font-semibold px-8 py-3 rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl transform hover:scale-[1.02]"
                        onclick="navigate('${userId ? (isAdmin ? 'admin-dashboard' : 'dashboard') : 'login'}')">
                        ${userId ? (isAdmin ? 'Go to Admin Panel' : 'Go to Dashboard') : 'Start Learning Now'} <i data-lucide="arrow-right" class="inline w-5 h-5 ml-1"></i>
                    </button>
                </div>
                <div class="mt-16 grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    ${languages.map(lang => `
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 ${lang.color}">
                            <i data-lucide="${lang.icon}" class="w-8 h-8 ${lang.accent} mb-3"></i>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${lang.name}</h3>
                            <p class="text-gray-600">Instant AI Tutor available.</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAboutPage() {
            return `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <h2 class="text-4xl font-bold text-gray-900 mb-6 border-b pb-2">About Easy Learn</h2>
                    <p class="text-lg text-gray-700 mb-4">
                        Easy Learn focuses solely on providing an instantaneous, AI-driven environment for language practice. Forget structured lessons—just ask your question and practice!
                    </p>
                    
                    <div class="space-y-6 mt-8">
                        <div>
                            <h3 class="text-2xl font-semibold text-indigo-600 mb-2">AI-Powered Practice</h3>
                            <p class="text-gray-600">
                                We use advanced Large Language Models (Gemini API) to give you real-time explanations, contextual examples, and instant feedback tailored to your questions.
                            </p>
                        </div>

                        <div>
                            <h3 class="text-2xl font-semibold text-indigo-600 mb-2">Our Languages (Admin Managed)</h3>
                            <p class="text-gray-600">
                                The list of available languages is dynamically controlled by the site administrator using the integrated Firebase Firestore panel.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginPage() {
            const currentRoute = window.appState.currentPage;

            return `
                <div class="max-w-md mx-auto py-16">
                    <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-indigo-500">
                        <i data-lucide="lock" class="w-10 h-10 mx-auto text-indigo-500 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">User Log In / Sign Up</h2>
                        
                        <form id="auth-form" onsubmit="event.preventDefault()">
                            <div class="space-y-4">
                                <div>
                                    <label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <input type="email" id="email-input" required placeholder="name@example.com"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                                </div>
                                
                                <div>
                                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Password (min. 6 characters)</label>
                                    <input type="password" id="password-input" required placeholder="••••••••" minlength="6"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                                </div>
                            </div>
                            
                            <div class="mt-8 space-y-4">
                                <button type="button" 
                                    class="w-full bg-indigo-600 text-white text-lg font-semibold px-8 py-3 rounded-full hover:bg-indigo-700 transition duration-300 shadow-lg transform hover:scale-[1.01]"
                                    onclick="handleFormSubmit(event, 'login')">
                                    Log In <i data-lucide="log-in" class="inline w-5 h-5 ml-2"></i>
                                </button>

                                <button type="button"
                                    class="w-full bg-gray-200 text-indigo-600 text-lg font-semibold px-8 py-3 rounded-full hover:bg-gray-300 transition duration-300 shadow-md"
                                    onclick="handleFormSubmit(event, 'signup')">
                                    Sign Up <i data-lucide="user-plus" class="inline w-5 h-5 ml-2"></i>
                                </button>
                            </div>
                        </form>

                        <div class="mt-6 text-center text-sm text-gray-500">
                            Are you the admin? <a href="#" onclick="showAdminModal()" class="text-indigo-600 hover:underline font-medium">Click here to log in.</a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Custom Admin Modal for clarity
        window.showAdminModal = function() {
            showCustomModal(
                "Admin Login Info", 
                `Use the designated administrator email: <code class="bg-gray-100 p-1 rounded font-mono">${ADMIN_EMAIL}</code> to gain admin privileges after logging in.`, 
                'info'
            );
        }

        function renderDashboardPage() {
            const languages = Object.entries(window.appState.languagesConfig || {});

            if (languages.length === 0) {
                 return `
                    <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                        <h2 class="text-4xl font-bold text-gray-900 mb-2">No Languages Available</h2>
                        <p class="text-lg text-gray-600 mb-8">
                            Please check back later or contact the site administrator.
                        </p>
                        ${isAdmin ? `<button class="bg-red-600 text-white px-6 py-2 rounded-full mt-4" onclick="navigate('admin-dashboard')">Go to Admin Panel</button>` : ''}
                    </div>
                `;
            }

            return `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-4xl font-bold text-gray-900 mb-2">Select Your Language Tutor</h2>
                    <p class="text-lg text-gray-600 mb-8">
                        You are logged in as a standard user (${userEmail || 'Guest'}). User ID: <code class="font-mono bg-gray-100 p-1 rounded text-sm text-indigo-700">${userId}</code>.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${languages.map(([key, lang]) => `
                            <div class="bg-gray-50 rounded-xl p-6 shadow-md border border-gray-200 hover:shadow-xl transition duration-300 cursor-pointer flex flex-col items-center text-center ${lang.accent}"
                                 onclick="navigate('learn', '${key}')">
                                <i data-lucide="${lang.icon}" class="w-10 h-10 ${lang.accent} mb-4"></i>
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">${lang.name}</h3>
                                <p class="text-gray-500 mb-4">Instant AI Tutor</p>
                                <button class="mt-2 text-white ${lang.color} px-4 py-2 rounded-full font-medium shadow-md hover:shadow-lg">Start Chatting</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAdminDashboardPage() {
            if (!isAdmin) return renderDashboardPage(); // Fallback if navigated directly without admin status

            const languages = Object.entries(window.appState.languagesConfig || {});
            
            return `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-4xl font-bold text-red-600 mb-2 flex items-center">
                        <i data-lucide="shield-alert" class="w-8 h-8 mr-3"></i> Admin Panel
                    </h2>
                    <p class="text-lg text-gray-600 mb-8 border-b pb-4">
                        Logged in as Administrator (${userEmail}). Use this panel to manage the site's available language tutors.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Language Management Form -->
                        <div class="lg:col-span-1 bg-gray-50 p-6 rounded-xl shadow-inner h-fit">
                            <h3 class="text-2xl font-semibold text-indigo-600 mb-4">Add / Edit Language</h3>
                            <form onsubmit="addOrUpdateLanguage(event)" id="language-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Key (e.g., english)</label>
                                    <input type="text" name="key" required placeholder="unique-key" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Display Name (e.g., English)</label>
                                    <input type="text" name="name" required placeholder="Language Name" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Icon (Lucide Icon Name)</label>
                                    <input type="text" name="icon" required placeholder="book-open, landmark, etc." class="w-full p-2 border rounded-lg">
                                    <p class="text-xs text-gray-500 mt-1">Check lucide.dev for names.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tailwind Color (e.g., bg-blue-500)</label>
                                    <input type="text" name="color" required placeholder="bg-color-500" class="w-full p-2 border rounded-lg">
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-full font-semibold hover:bg-indigo-700 transition">
                                    Save Language
                                </button>
                            </form>
                        </div>

                        <!-- Existing Languages List -->
                        <div class="lg:col-span-2">
                            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Current Languages (${languages.length})</h3>
                            <div class="space-y-3">
                                ${languages.map(([key, lang]) => `
                                    <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-4 ${lang.color}">
                                        <div>
                                            <p class="text-xl font-bold text-gray-900">${lang.name} (<span class="font-mono text-sm text-gray-500">${key}</span>)</p>
                                            <div class="flex items-center text-sm text-gray-600 mt-1 space-x-2">
                                                <i data-lucide="${lang.icon}" class="w-4 h-4 ${lang.accent}"></i>
                                                <span>Icon: ${lang.icon}</span>
                                                <span>Color: ${lang.color}</span>
                                            </div>
                                        </div>
                                        <button onclick="deleteLanguage('${key}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                `).join('')}
                                ${languages.length === 0 ? '<p class="text-gray-500 italic">No languages defined. Use the form to add one!</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        


        function renderLearnPage() {
            const langKey = window.appState.selectedLanguage;
            const content = window.appState.languagesConfig[langKey];

            if (!content) {
                 return `<div class="p-8 text-center text-red-500">Error: Please select a language from the <a href="#" onclick="navigate('dashboard')" class="text-indigo-600 hover:underline">Dashboard</a>.</div>`;
            }

            return `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col h-[80vh] border-t-4 border-indigo-500">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h1 class="text-3xl font-bold text-gray-900 flex items-center space-x-2">
                                <i data-lucide="robot" class="w-7 h-7 text-indigo-600"></i>
                                <span>AI Tutor: ${content.name}</span>
                            </h1>
                            <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center" onclick="navigate('dashboard')">
                                <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Change Language
                            </button>
                        </div>

                        <div id="ai-chat-history" class="flex-grow overflow-y-auto custom-scrollbar p-2 mb-4 bg-gray-50 rounded-lg space-y-4">
                        </div>

                        <form id="ai-chat-form" onsubmit="handleChatSubmit(event)" class="flex items-center space-x-3">
                            <input type="text" id="ai-chat-input" placeholder="Ask a question about ${content.name}..." required
                                class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-200"
                                ${window.appState.isChatLoading ? 'disabled' : ''}>
                            <button type="submit"
                                class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-indigo-300"
                                ${window.appState.isChatLoading ? 'disabled' : ''}>
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                        <p class="text-xs text-gray-500 mt-2">The AI Tutor uses Google Search for current, grounded information.</p>
                    </div>
                </div>
            `;
        }

        function handleChatSubmit(event) {
            event.preventDefault();
            const inputElement = document.getElementById('ai-chat-input');
            const question = inputElement.value.trim();
            if (question) {
                askAIQuestion(question);
                inputElement.value = ''; 
            }
        }

        function renderChat() {
            const chatHistoryDiv = document.getElementById('ai-chat-history');
            if (!chatHistoryDiv) return;

            const welcomeMessage = `
                <div class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-3 rounded-xl rounded-tl-none max-w-xs md:max-w-md shadow-md">
                        <strong class="text-indigo-600">AI Tutor:</strong>
                        <p>Hello! I'm your tutor for **${window.appState.languagesConfig[window.appState.selectedLanguage].name}**. Ask me any question you have about grammar, vocabulary, or culture. Feel free to practice speaking here too!</p>
                    </div>
                </div>
            `;
            
            const chatMessages = window.appState.chatHistory.map(message => {
                if (message.role === 'user') {
                    return `
                        <div class="flex justify-end">
                            <div class="bg-indigo-500 text-white p-3 rounded-xl rounded-br-none max-w-xs md:max-w-md shadow-md">
                                ${message.text}
                            </div>
                        </div>
                    `;
                } else {
                    let sourcesHtml = '';
                    if (message.sources && message.sources.length > 0) {
                        const uniqueSources = Array.from(new Set(message.sources.map(s => s.title))).slice(0, 3);
                        sourcesHtml = `
                            <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-500">
                                <p class="font-semibold mb-1">Sources:</p>
                                ${uniqueSources.map(title => `<span class="block italic">${title}</span>`).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="flex justify-start">
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-xl rounded-tl-none max-w-xs md:max-w-md shadow-md">
                                <strong class="text-indigo-600">AI Tutor:</strong>
                                <p class="whitespace-pre-wrap">${message.text}</p>
                                ${sourcesHtml}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            chatHistoryDiv.innerHTML = welcomeMessage + chatMessages;

            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            lucide.createIcons();
        }


        // Global functions exposed to window for HTML event handlers
        window.navigate = navigate;
        window.toggleMobileMenu = toggleMobileMenu;
        window.handleChatSubmit = handleChatSubmit;
        window.askAIQuestion = askAIQuestion; 
        window.handleLogout = handleLogout;
        window.showCustomModal = showCustomModal; // Exporting for usage in custom UI
        window.handleFormSubmit = handleFormSubmit;
        window.addOrUpdateLanguage = addOrUpdateLanguage;
        window.deleteLanguage = deleteLanguage;


        // Initialize App on load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
