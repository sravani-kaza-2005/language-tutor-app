<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Learn - AI Language Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import and styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Colorful gradient background */
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 25%, #f9d423 50%, #f83600 75%, #43cea2 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        /* Custom scrollbar for chat/content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Slate 300 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <button onclick="closeLoginModal()" class="absolute top-2 right-2 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
            <h2 id="form-title" class="text-2xl font-bold mb-4 text-center">Sign In</h2>
            <form id="signin-form">
                <label for="signin-username" class="block text-gray-700 mb-1">Username</label>
                <input type="text" id="signin-username" name="signin-username" required class="w-full mb-3 p-2 border rounded">
                <label for="signin-password" class="block text-gray-700 mb-1">Password</label>
                <input type="password" id="signin-password" name="signin-password" required class="w-full mb-4 p-2 border rounded">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded mb-2 hover:bg-indigo-700 transition">Sign In</button>
            </form>
            <form id="signup-form" style="display:none;">
                <label for="signup-username" class="block text-gray-700 mb-1">Username</label>
                <input type="text" id="signup-username" name="signup-username" required class="w-full mb-3 p-2 border rounded">
                <label for="signup-password" class="block text-gray-700 mb-1">Password</label>
                <input type="password" id="signup-password" name="signup-password" required class="w-full mb-3 p-2 border rounded">
                <label for="signup-confirm" class="block text-gray-700 mb-1">Confirm Password</label>
                <input type="password" id="signup-confirm" name="signup-confirm" required class="w-full mb-4 p-2 border rounded">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded mb-2 hover:bg-indigo-700 transition">Sign Up</button>
            </form>
            <span class="block text-center text-indigo-600 cursor-pointer mt-2 underline hover:text-indigo-800" id="toggle-link">Don't have an account? Sign up</span>
            
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button onclick="handleGuestLogin()" class="w-full bg-gray-500 text-white text-md font-semibold py-2 rounded-full hover:bg-gray-600 transition duration-300 shadow">
                    Quick Start (Anonymous)
                </button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative text-center">
            <button onclick="closeProfileModal()" class="absolute top-2 right-2 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4">User Profile</h2>
            <div class="text-lg text-indigo-700 mb-6" id="username-display"></div>
            <button onclick="logoutLocalUser()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Logout</button>
        </div>
    </div>

    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2 text-2xl font-extrabold text-indigo-600 tracking-tight" onclick="navigate('home')">
                <i data-lucide="graduation-cap" class="w-6 h-6 text-indigo-500"></i>
                <span>Easy Learn</span>
            </a>
            <nav class="hidden md:flex space-x-6 text-gray-700 font-medium">
                <a href="#" class="hover:text-indigo-600 transition duration-150" onclick="navigate('home')">Home</a>
                <a href="#" class="hover:text-indigo-600 transition duration-150" id="dashboard-nav-link">Dashboard</a>
                <a href="#" class="hover:text-indigo-600 transition duration-150" onclick="navigate('about')">About</a>
                <a href="#" class="hover:text-indigo-600 transition duration-150" onclick="openProfileModal()">Profile</a>
                <a href="#" class="text-white bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-full shadow-md transition duration-150" id="auth-button" onclick="openLoginModal()">Login</a>
            </nav>
            <button id="mobile-menu-button" class="md:hidden p-2 text-gray-700 hover:text-indigo-600" onclick="toggleMobileMenu()">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-inner pb-2 border-t">
            <nav class="flex flex-col space-y-2 px-4 py-2 font-medium">
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" onclick="navigate('home')">Home</a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" id="dashboard-nav-link-mobile">Dashboard</a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" onclick="navigate('about')">About</a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-indigo-50" onclick="openProfileModal()">Profile</a>
                <a href="#" class="block px-3 py-2 rounded-md text-white bg-indigo-500 text-center rounded-full mt-2" id="auth-button-mobile" onclick="openLoginModal()">Login</a>
            </nav>
        </div>
    </header>

    <main id="app-content" class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 w-full"></main>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500 border-opacity-20 border-t-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold">Loading Easy Learn...</p>
        </div>
    </div>
    <div id="ai-loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="animate-pulse rounded-full h-10 w-10 bg-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold text-lg">AI Tutor is thinking...</p>
            <p class="text-sm text-gray-500 mt-1">Fetching information from the web.</p>
        </div>
    </div>

    <script>
        // Mock variables for local dev environment
        const __app_id = 'test-local-app';
        const __firebase_config = '{}'; 
        const __initial_auth_token = null;

        // --- LOGIN/SIGNUP/PROFILE LOGIC (LOCALSTORAGE) - CENTRALIZED FIX ---

        window.openLoginModal = function() {
            // Reset to Sign In state when opening
            document.getElementById('signin-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById('form-title').textContent = 'Sign In';
            document.getElementById('toggle-link').textContent = "Don't have an account? Sign up";
            document.getElementById('login-modal').classList.remove('hidden');
        };

        window.closeLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
        };

        window.openProfileModal = function() {
            const username = localStorage.getItem('easy_learn_logged_in');
            if (!username) {
                openLoginModal(); 
                return;
            }
            document.getElementById('username-display').textContent = 'Username: ' + username;
            document.getElementById('profile-modal').classList.remove('hidden');
        };

        window.closeProfileModal = function() {
            document.getElementById('profile-modal').classList.add('hidden');
        };

        // This calls the main module's handleLogout
        window.logoutLocalUser = function() {
            if (typeof handleLogout === 'function') {
                handleLogout(); 
            } else {
                localStorage.removeItem('easy_learn_logged_in');
                navigate('home');
            }
            closeProfileModal();
        };

        function getUsers() {
            const users = localStorage.getItem('easy_learn_users');
            return users ? JSON.parse(users) : {};
        }

        function saveUsers(users) {
            localStorage.setItem('easy_learn_users', JSON.stringify(users));
        }

        // --- NEW CENTRALIZED LOGIN SUCCESS HANDLER ---
        window.handleLocalLoginSuccess = function(username) {
            localStorage.setItem('easy_learn_logged_in', username);
            
            // CRITICAL FIX: Inform the module script to update its private userId variable
            if (typeof updateGlobalUserId === 'function') {
                updateGlobalUserId(username);
            }
            
            // Update UI and navigate to dashboard
            if (typeof updateUIOnAuth === 'function' && typeof navigate === 'function') {
                updateUIOnAuth();
                navigate('dashboard');
            }
            closeLoginModal();
        };
        // --- END NEW CENTRALIZED LOGIN SUCCESS HANDLER ---


        // --- ATTACH FORM SUBMISSION LISTENERS (UPDATED TO USE CENTRALIZED HANDLER) ---
        document.addEventListener('DOMContentLoaded', function() {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const toggleLink = document.getElementById('toggle-link');
            const formTitle = document.getElementById('form-title');

            if (!signinForm || !signupForm) return;

            // Toggle logic (unchanged)
            toggleLink.onclick = function() {
                if (signinForm.style.display !== 'none') {
                    signinForm.style.display = 'none';
                    signupForm.style.display = 'block';
                    formTitle.textContent = 'Sign Up';
                    toggleLink.textContent = 'Already have an account? Sign In';
                } else {
                    signinForm.style.display = 'block';
                    signupForm.style.display = 'none';
                    formTitle.textContent = 'Sign In';
                    toggleLink.textContent = "Don't have an account? Sign Up";
                }
            };

            // Sign In Submission - FIXED
            signinForm.onsubmit = function(e) {
                e.preventDefault();
                const username = document.getElementById('signin-username').value.trim();
                const password = document.getElementById('signin-password').value;
                const users = getUsers();

                if (users[username] && users[username] === password) {
                    window.handleLocalLoginSuccess(username); 
                } else {
                    alert('Invalid username or password.');
                }
            };

            // Sign Up Submission - FIXED
            signupForm.onsubmit = function(e) {
                e.preventDefault();
                const username = document.getElementById('signup-username').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;

                if (password !== confirm) {
                    alert('Passwords do not match.');
                    return;
                }
                if (!username || !password) {
                    alert('Please fill all fields.');
                    return;
                }
                
                const users = getUsers();
                if (users[username]) {
                    alert('Username already exists. Please choose another.');
                    return;
                }

                // 1. Save new user
                users[username] = password;
                saveUsers(users);

                // 2. Log in immediately
                window.handleLocalLoginSuccess(username);
                alert('Sign up successful! You are now logged in.');
            };
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Global variables for Firebase services and state
        let app = null;
        let db;
        let auth;
        // CRITICAL FIX: Initialize userId from localStorage on module load
        let userId = localStorage.getItem('easy_learn_logged_in'); 
        let isAuthReady = false;

        // --- GLOBAL ENVIRONMENT VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-easy-learn-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END OF GLOBAL ENVIRONMENT VARIABLES ---

        // Expose global functions needed by the script block above
        window.updateUIOnAuth = updateUIOnAuth;
        window.navigate = navigate;
        window.handleLogout = handleLogout;
        window.handleGuestLogin = handleGuestLogin;
        // CRITICAL FIX: Expose function to allow the local script to update internal userId
        window.updateGlobalUserId = (newId) => { userId = newId; }; 

        // Global application state
        window.appState = {
            currentPage: 'home',
            selectedLanguage: null,
            chatHistory: [],
            isChatLoading: false
        };

        // Static Language Content Data
        const CONTENT_MAP = {
            english: { name: "English", icon: "book-open", color: "bg-green-500", accent: "text-green-600" },
            hindi: { name: "Hindi (हिंदी)", icon: "landmark", color: "bg-red-500", accent: "text-red-600" },
            telugu: { name: "Telugu (తెలుగు)", icon: "users", color: "bg-blue-500", accent: "text-blue-600" },
            tamil: { name: "Tamil (தமிழ்)", icon: "bus", color: "bg-yellow-500", accent: "text-yellow-600" }
        };

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initializeFirebase() {
            try {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.classList.remove('hidden');

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // Firebase user takes precedence
                            userId = user.uid;
                        } else if (!localStorage.getItem('easy_learn_logged_in')) { 
                            // Only clear userId if Firebase signs out AND there's no local login
                             userId = null;
                        }
                        isAuthReady = true;
                        updateUIOnAuth();
                        renderApp();
                        loadingOverlay.classList.add('hidden');
                    });

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                } else {
                    // Running locally without config
                    if (!userId) { 
                        userId = null;
                    }
                    isAuthReady = true;
                    updateUIOnAuth();
                    renderApp();
                    loadingOverlay.classList.add('hidden');
                }
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function handleGuestLogin() {
            const guestUsername = 'Guest_' + Math.random().toString(16).slice(2, 8).toUpperCase();
            
            // Simulate local login for consistency
            window.handleLocalLoginSuccess(guestUsername);
            
            // Firebase part (kept for completeness, but local mode handles the user state)
            if (app) {
                 try {
                    await signInAnonymously(auth);
                 } catch (error) {
                    console.error("Firebase Guest Login failed:", error);
                 }
            }
            
            closeLoginModal();
        }

        async function handleLogout() {
            localStorage.removeItem('easy_learn_logged_in'); 
            
            // Update internal state
            userId = null;
            window.appState.selectedLanguage = null;
            window.appState.chatHistory = [];

            if (auth && auth.currentUser) {
                // Real Firebase logout
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Firebase Logout failed:", error);
                }
            }
            
            updateUIOnAuth();
            navigate('login');
        }

        function updateUIOnAuth() {
            const authButton = document.getElementById('auth-button');
            const authButtonMobile = document.getElementById('auth-button-mobile');
            const dashboardNavLink = document.getElementById('dashboard-nav-link');
            const dashboardNavLinkMobile = document.getElementById('dashboard-nav-link-mobile');

            // Use the current internal userId state
            const currentUserId = userId; 
            
            if (!authButton || !dashboardNavLink) return;

            // Set Dashboard link target
            const dashboardAction = () => navigate(currentUserId ? 'dashboard' : 'login');
            dashboardNavLink.onclick = dashboardAction;
            dashboardNavLinkMobile.onclick = () => { dashboardAction(); toggleMobileMenu(); };

            if (currentUserId) {
                // Logged In
                authButton.textContent = 'Logout';
                authButton.onclick = handleLogout;
                authButtonMobile.textContent = 'Logout';
                authButtonMobile.onclick = () => { handleLogout(); toggleMobileMenu(); };
                
            } else {
                // Logged Out
                authButton.textContent = 'Login';
                authButton.onclick = openLoginModal; 
                authButtonMobile.textContent = 'Login';
                authButtonMobile.onclick = () => { openLoginModal(); toggleMobileMenu(); };

                if (window.appState.currentPage === 'dashboard' || window.appState.currentPage === 'learn') {
                    window.appState.currentPage = 'home'; 
                    renderApp();
                }
            }
        }

        // --- AI (GEMINI) API INTERACTION ---
       
        const AI_MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const AI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=`;

        async function askAIQuestion(question) {
            if (window.appState.isChatLoading) return;
            if (!userId) {
                const modalHtml = `
                    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                            <h3 class="text-xl font-bold text-red-600 mb-3">Authentication Required</h3>
                            <p class="text-gray-700 mb-4">You must be logged in to use the AI Tutor.</p>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-700" onclick="document.getElementById('custom-alert-modal').remove(); navigate('login')">
                                Go to Login
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                return;
            }

            window.appState.isChatLoading = true;
            document.getElementById('ai-loading-modal').classList.remove('hidden');

            // Add user message to state
            window.appState.chatHistory.push({ role: 'user', text: question });
            renderChat();

            const selectedLang = CONTENT_MAP[window.appState.selectedLanguage]?.name || 'a general language learning topic';
            const systemPrompt = `You are Easy Learn, a friendly and expert language tutor specializing in ${selectedLang}. Your role is to answer the user's questions clearly, provide simple examples, and encourage them to practice. If the user asks a question in ${selectedLang} or related to it, respond directly using ${selectedLang} and provide an English translation or explanation. Keep responses concise and directly relevant to language learning.`;

            const payload = {
                contents: [{ parts: [{ text: question }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiKey = "AIzaSyBr8bUWi8Rk9ycgffKrqSJu7k0kcxXMwpU"; // API key updated by user

            let responseText = "Sorry, I couldn't connect to the AI tutor. Please try again later.";
            let sources = [];
            let delay = 1000;
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(AI_API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        responseText = candidate.content.parts[0].text;

                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        break; // Success
                    } else {
                        throw new Error("Invalid response structure from AI.");
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }

            // Add AI response to state
            window.appState.chatHistory.push({ role: 'ai', text: responseText, sources: sources });
            window.appState.isChatLoading = false;
            document.getElementById('ai-loading-modal').classList.add('hidden');
            renderChat();
        }

        // --- UI/RENDERING FUNCTIONS (UNCHANGED) ---

        function navigate(page, langKey = null) {
            window.appState.currentPage = page;

            if (page === 'learn' && langKey) {
                if (!userId) {
                    openLoginModal();
                    return navigate('home');
                }
                window.appState.selectedLanguage = langKey;
                window.appState.chatHistory = []; 
            } else if (page === 'dashboard' && !userId) {
                return navigate('home');
            }
            
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
            renderApp();
            window.scrollTo(0, 0);
        }
        
        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        function renderApp() {
            const contentDiv = document.getElementById('app-content');
            let html = '';

            if (userId && window.appState.currentPage === 'login') {
                window.appState.currentPage = 'dashboard';
            }

            switch (window.appState.currentPage) {
                case 'home':
                    html = renderHomePage();
                    break;
                case 'about':
                    html = renderAboutPage();
                    break;
                case 'login':
                    openLoginModal();
                    html = renderHomePage();
                    break;
                case 'dashboard':
                    html = renderDashboardPage();
                    break;
                case 'learn':
                    html = renderLearnPage();
                    break;
                default:
                    html = renderHomePage();
            }

            contentDiv.innerHTML = html;
            lucide.createIcons();

            if (window.appState.currentPage === 'learn') {
                renderChat();
            }
        }


        // --- PAGE RENDERERS (UNCHANGED) ---

        function renderHomePage() {
             return `
                <div class="text-center py-20 bg-indigo-50 rounded-xl shadow-lg">
                    <i data-lucide="zap" class="w-12 h-12 mx-auto text-indigo-500 mb-4"></i>
                    <h1 class="text-5xl font-extrabold text-gray-900 leading-tight mb-4">
                        Master Languages with <span class="text-indigo-600">Easy Learn</span>
                    </h1>
                    <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
                        Ask our AI Tutor anything about English, Hindi, Telugu, or Tamil. Get instant, real-time feedback and practice.
                    </p>
                    <button class="bg-indigo-600 text-white text-lg font-semibold px-8 py-3 rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl transform hover:scale-[1.02]"
                        onclick="${userId ? "navigate('dashboard')" : "openLoginModal();"}">
                        ${userId ? 'Go to Dashboard' : 'Start Learning Now'} <i data-lucide="arrow-right" class="inline w-5 h-5 ml-1"></i>
                    </button>
                </div>
                <div class="mt-16 grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    ${Object.values(CONTENT_MAP).map(lang => `
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 ${lang.color}">
                            <i data-lucide="${lang.icon}" class="w-8 h-8 ${lang.accent} mb-3"></i>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${lang.name}</h3>
                            <p class="text-gray-600">Instant AI Tutor available.</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAboutPage() {
             return `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <h2 class="text-4xl font-bold text-gray-900 mb-6 border-b pb-2">About Easy Learn</h2>
                    <p class="text-lg text-gray-700 mb-4">
                        Easy Learn focuses solely on providing an instantaneous, AI-driven environment for language practice. Forget structured lessons—just ask your question and practice!
                    </p>
                    
                    <div class="space-y-6 mt-8">
                        <div>
                            <h3 class="text-2xl font-semibold text-indigo-600 mb-2">AI-Powered Practice</h3>
                            <p class="text-gray-600">
                                We use advanced Large Language Models (Gemini API) to give you real-time explanations, contextual examples, and instant feedback tailored to your questions in your chosen language.
                            </p>
                        </div>

                        <div>
                            <h3 class="text-2xl font-semibold text-indigo-600 mb-2">Our Languages</h3>
                            <p class="text-gray-600">
                                We offer dedicated AI tutors for **English, Hindi, Telugu, and Tamil**.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboardPage() {
            const localUser = localStorage.getItem('easy_learn_logged_in');
            const displayName = localUser ? localUser : (userId ? 'Guest' : 'User');

            return `
                <div class="max-w-7xl mx-auto py-10">
                    <div class="bg-white p-8 rounded-xl shadow-xl mb-10 text-center">
                        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                            Welcome, <span class="text-indigo-600">${displayName}</span>!
                        </h1>
                        <p class="text-xl text-gray-600">Select a language to begin your practice with the AI Tutor.</p>
                    </div>

                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Choose Your Tutor</h2>

                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        ${Object.entries(CONTENT_MAP).map(([key, lang]) => `
                            <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 ${lang.color} flex flex-col items-center text-center transition duration-300 hover:shadow-2xl hover:scale-[1.03]">
                                <i data-lucide="${lang.icon}" class="w-10 h-10 ${lang.accent} mb-4"></i>
                                <h3 class="text-2xl font-bold text-gray-900 mb-3">${lang.name}</h3>
                                <p class="text-gray-600 mb-4 flex-grow">Start an interactive chat session with your personal AI language tutor.</p>
                                <button class="mt-4 bg-indigo-600 text-white font-medium px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-150 w-full"
                                    onclick="navigate('learn', '${key}')">
                                    Start Practice
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderLearnPage() {
            const langKey = window.appState.selectedLanguage;
            const langData = CONTENT_MAP[langKey];

            if (!langData) {
                return renderDashboardPage();
            }

            return `
                <div class="flex flex-col h-[calc(100vh-68px)] max-h-[calc(100vh-68px)] w-full max-w-none mx-0 px-0">
                    <div class="bg-white p-4 shadow-md flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center space-x-3">
                            <button onclick="navigate('dashboard')" class="text-gray-500 hover:text-indigo-600">
                                <i data-lucide="arrow-left" class="w-6 h-6"></i>
                            </button>
                            <h2 class="text-2xl font-bold text-gray-900">
                                AI Tutor: <span class="${langData.accent}">${langData.name}</span>
                            </h2>
                        </div>
                        <button class="text-sm text-indigo-600 hover:underline" onclick="window.appState.chatHistory = []; renderChat();">
                            Clear Chat
                        </button>
                    </div>

                    <div id="chat-window" class="flex-grow p-4 overflow-y-auto custom-scrollbar bg-gray-50 space-y-4">
                        </div>

                    <div class="bg-white p-4 shadow-xl flex-shrink-0 border-t">
                        <form id="chat-input-form" class="flex space-x-2" onsubmit="event.preventDefault(); submitChatQuestion();">
                            <input type="text" id="chat-input" placeholder="Ask your ${langData.name} question..." required 
                                class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            <button type="submit" id="chat-send-button" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
                                <i data-lucide="send" class="w-6 h-6"></i>
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // Helper function to render the chat history and scroll to bottom
        function renderChat() {
            const chatWindow = document.getElementById('chat-window');
            if (!chatWindow) return;

            const langKey = window.appState.selectedLanguage;
            const langName = CONTENT_MAP[langKey]?.name || 'Language Tutor';
            const isNewChat = window.appState.chatHistory.length === 0;

            let chatHtml = '';

            if (isNewChat) {
                chatHtml += `
                    <div class="text-center p-8 bg-white rounded-xl shadow-lg mt-8">
                        <i data-lucide="message-square" class="w-10 h-10 mx-auto text-indigo-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Start Your ${langName} Practice</h3>
                        <p class="text-gray-600">Ask me anything! For example: "How do you say 'hello' in ${langName}?" or "Explain the past tense grammar in English."</p>
                    </div>
                `;
            } else {
                chatHtml = window.appState.chatHistory.map(message => {
                    const isUser = message.role === 'user';
                    const alignment = isUser ? 'justify-end' : 'justify-start';
                    const bubbleColor = isUser ? 'bg-indigo-600 text-white' : 'bg-white text-gray-900 border border-gray-200 shadow-md';
                    const name = isUser ? 'You' : 'AI Tutor';
                    const icon = isUser ? 'user' : 'bot';

                    let sourcesHtml = '';
                    if (message.sources && message.sources.length > 0) {
                        sourcesHtml = `
                            <div class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500">
                                <strong>Sources:</strong> 
                                ${message.sources.slice(0, 3).map(src => `<a href="${src.uri}" target="_blank" class="hover:underline">${src.title || 'Source'}</a>`).join(', ')}
                            </div>
                        `;
                    }

                    return `
                        <div class="flex ${alignment}">
                            <div class="max-w-3/4 p-4 rounded-xl ${bubbleColor} ${isUser ? 'ml-auto' : 'mr-auto'}">
                                <div class="font-semibold text-sm mb-1 flex items-center space-x-1 ${isUser ? 'text-indigo-200' : 'text-indigo-600'}">
                                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                                    <span>${name}</span>
                                </div>
                                <div class="prose max-w-none">
                                    ${message.text.replace(/\n/g, '<br>')}
                                </div>
                                ${sourcesHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            chatWindow.innerHTML = chatHtml;
            lucide.createIcons();
            
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button');
            if (chatInput && sendButton) {
                if (!window.appState.isChatLoading) {
                    chatInput.value = '';
                    chatInput.focus();
                }
                sendButton.disabled = window.appState.isChatLoading;
            }

        }

        window.submitChatQuestion = function() {
            const inputField = document.getElementById('chat-input');
            const question = inputField.value.trim();

            if (question && !window.appState.isChatLoading) {
                askAIQuestion(question);
                inputField.value = '';
            }
        };


        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });

    </script>
</body>
</html>
